# ĞĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ workflow
name: pw tests
# ĞšĞ¾Ğ³Ğ´Ğ° Ğ¼Ñ‹ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ°Ğ²Ñ‚Ğ¾Ñ‚ĞµÑÑ‚Ñ‹
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
 # Ñ€ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº   
  workflow_dispatch:
# jobs
jobs:
  e2eTests:
    timeout-minutes: 30
    runs-on: ubuntu-latest
    steps:
      # Ğ´ĞµĞ»Ğ°ĞµĞ¼ Ñ‡ĞµĞºĞ°ÑƒÑ‚
      - uses: actions/checkout@v4
      # ÑƒÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ node.js
      - uses: actions/setup-node@v4
        with:
          node-version: lts/*
      # ÑƒÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¿Ğ°ĞºĞµÑ‚Ñ‹ node
      - name: Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ğ°ĞºĞµÑ‚Ñ‹
        run: npm i
      # ÑƒÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ PW
      - name: Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ PW
        run: npx playwright install --with-deps
      - name: Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ PW
        run: npm run test
      # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ¾Ñ‚Ñ‡ĞµÑ‚ PW  
      - uses: actions/upload-artifact@v4
        if: always()
        continue-on-error: true
        with:
          name: test-results
          path: test-results
          retention-days: 20
      # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Allure 
      - uses: actions/upload-artifact@v4
        if: always()
        continue-on-error: true
        with:
          name: allure-results
          path: allure-results
          retention-days: 20
      # Ğ—Ğ°Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰ĞµĞ³Ğ¾ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°  
      - uses: actions/checkout@v4
        if: always()
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages
      # Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¸Ğ· allure-results Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚ allure-report
      - uses: simple-elf/allure-report-action@master
        if: always()
        id: allure-report
        with:
          allure_results: allure-results
          gh_pages: gh-pages
          allure_report: allure-report
          allure_history: allure-history
          keep_reports: 20
      # Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¸Ğ¼ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚
      - name: Deploy Report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        if: always()
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./playwright-report  # Ğ¸Ğ»Ğ¸ ĞºÑƒĞ´Ğ° Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ‚ÑÑ HTML
          publish_branch: gh-pages         # Ğ²ĞµÑ‚ĞºĞ° Ğ±ÑƒĞ´ĞµÑ‚ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ° Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸
          commit_message: ${{ github.event_name }}-${{ github.run_id }}

      - name: Install allurectl
        run: |
          wget https://github.com/allure-framework/allurectl/releases/latest/download/allurectl-linux-amd64.tar.gz
          tar -xzf allurectl-linux-amd64.tar.gz
          sudo mv allurectl /usr/local/bin/


      - name: Upload results to Allure TestOps
        run: |
          allurectl upload allure-results \
        --url ${{ secrets.ALLURE_TESTOPS_URL }} \
        --project-id ${{ secrets.ALLURE_TESTOPS_PROJECT_ID }} \
        --api-key ${{ secrets.ALLURE_TESTOPS_API_KEY }}


      - name: Parse Allure summary
        id: parse_summary
        if: always()
        run: |
          SUMMARY_FILE="allure-report/widgets/summary.json"
          if [ -f "$SUMMARY_FILE" ]; then
            PASSED=$(jq '.statistic.passed' $SUMMARY_FILE)
            FAILED=$(jq '.statistic.failed' $SUMMARY_FILE)
            SKIPPED=$(jq '.statistic.skipped' $SUMMARY_FILE)
            TOTAL=$(jq '.statistic.total' $SUMMARY_FILE)
            echo "PASSED=$PASSED" >> $GITHUB_ENV
            echo "FAILED=$FAILED" >> $GITHUB_ENV
            echo "SKIPPED=$SKIPPED" >> $GITHUB_ENV
            echo "TOTAL=$TOTAL" >> $GITHUB_ENV
          fi

      - name: Upload Allure Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
            name: allure-results
            path: allure-results/
            retention-days: 30

      - name: Send Telegram notification
        uses: appleboy/telegram-action@v1.0.1
        if: always()
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ğŸ“¦ *Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ°Ğ²Ñ‚Ğ¾Ñ‚ĞµÑÑ‚Ğ¾Ğ²* 
            ğŸ¯ Ğ ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¹: ${{ github.repository }}
            ğŸ”„ Ğ’ĞµÑ‚ĞºĞ°: ${{ github.ref_name }}
            ğŸ• Ğ’Ñ€ĞµĞ¼Ñ: ${{ github.event.repository.pushed_at }}
            âœ… Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: ${{ job.status }}
            
            ${{ steps.playwright.conclusion == 'success' && 'ğŸŸ¢ Ğ’ÑĞµ Ñ‚ĞµÑÑ‚Ñ‹ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¸!' || 'ğŸ”´ Ğ¢ĞµÑÑ‚Ñ‹ ÑƒĞ¿Ğ°Ğ»Ğ¸!' }}

            ğŸ”— [ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ğ»Ğ¾Ğ³Ğ¸](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          format: markdown

     