name: pw tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  e2eTests:
    timeout-minutes: 30
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ğ°ĞºĞµÑ‚Ñ‹
        run: npm i

      - name: Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ PW
        run: npx playwright install --with-deps

      - name: Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ PW
        id: playwright
        run: npm run test

      - name: Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Playwright
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: test-results/
          retention-days: 20

      - name: Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Allure
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-results
          path: allure-results/
          retention-days: 20

      - name: Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ jq
        run: sudo apt-get install -y jq

      - name: Setup allurectl
        if: always()
        run: |
          # ĞšÑÑˆĞ¸Ñ€ÑƒĞµĞ¼ allurectl
          if [ ! -f "/usr/local/bin/allurectl" ]; then
            echo "Installing allurectl..."
            curl -o allurectl -L "https://github.com/allure-framework/allurectl/releases/latest/download/allurectl_linux_amd64"
            chmod +x allurectl
            sudo mv allurectl /usr/local/bin/
          fi

      - name: Upload results to Allure TestOps
        if: success() || failure()
        run: |
          allurectl upload allure-results \
            --url ${{ secrets.ALLURE_TESTOPS_URL }} \
            --project-id ${{ secrets.ALLURE_TESTOPS_PROJECT_ID }} \
            --api-key ${{ secrets.ALLURE_TESTOPS_API_KEY }}

      - name: Ğ¡Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Allure Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚
        uses: simple-elf/allure-report-action@master
        if: always()
        with:
          allure_results: allure-results
          gh_pages: gh-pages
          allure_report: allure-report
          allure_history: allure-history
          keep_reports: 20

      - name: Parse Allure summary
        id: parse_summary
        if: always()
        run: |
          SUMMARY_FILE="allure-report/widgets/summary.json"
          if [ -f "$SUMMARY_FILE" ]; then
            PASSED=$(jq '.statistic.passed' $SUMMARY_FILE)
            FAILED=$(jq '.statistic.failed' $SUMMARY_FILE)
            SKIPPED=$(jq '.statistic.skipped' $SUMMARY_FILE)
            TOTAL=$(jq '.statistic.total' $SUMMARY_FILE)
          else
            PASSED=0; FAILED=0; SKIPPED=0; TOTAL=0
          fi
          echo "PASSED=$PASSED" >> $GITHUB_ENV
          echo "FAILED=$FAILED" >> $GITHUB_ENV
          echo "SKIPPED=$SKIPPED" >> $GITHUB_ENV
          echo "TOTAL=$TOTAL" >> $GITHUB_ENV

      - name: Check Allure Report
        run: |
          if [ -d "allure-report" ]; then
            echo "âœ… allure-report found"
            ls -la allure-report/
          else
            echo "âŒ allure-report not generated!"
            ls -la
            exit 1
          fi


      - name: Deploy Report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        if: always()
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./allure-report
          publish_branch: gh-pages
          commit_message: ${{ github.event_name }}-${{ github.run_id }}

      - name: Send Telegram notification
        uses: appleboy/telegram-action@v1.0.1
        if: always()
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ğŸ“¦ *Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ°Ğ²Ñ‚Ğ¾Ñ‚ĞµÑÑ‚Ğ¾Ğ²* 
            ğŸ¯ Ğ ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¹: ${{ github.repository }}
            ğŸ”„ Ğ’ĞµÑ‚ĞºĞ°: ${{ github.ref_name }}
            ğŸ• Ğ’Ñ€ĞµĞ¼Ñ: ${{ github.event.created_at || github.run_started_at }}
            âœ… Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: ${{ job.status }}
            
            ${{ steps.playwright.conclusion == 'success' && 'ğŸŸ¢ Ğ’ÑĞµ Ñ‚ĞµÑÑ‚Ñ‹ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¸!' || 'ğŸ”´ Ğ¢ĞµÑÑ‚Ñ‹ ÑƒĞ¿Ğ°Ğ»Ğ¸!' }}
            ğŸ“Š ĞŸÑ€Ğ¾Ğ¹Ğ´ĞµĞ½Ğ¾: ${{ env.PASSED }} / ${{ env.TOTAL }}

            ğŸ”— [ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ğ»Ğ¾Ğ³Ğ¸](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            ğŸ“Š [ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Allure Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/allure-report)
          format: markdown
